rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Las reglas se basan en el path: companies/{companyId}/...
    match /companies/{companyId}/{allPaths=**} {
      
      // Función para verificar si el usuario pertenece a la empresa.
      // Se usa el custom claim 'companyId' del token de autenticación.
      function isMemberOfCompany(cId) {
        return request.auth != null && request.auth.token.companyId == cId;
      }

      // Función para verificar si el usuario es administrador de la empresa.
      // Se usa el custom claim 'role'.
      function isAdminOfCompany(cId) {
        return isMemberOfCompany(cId) && request.auth.token.role in ['admin', 'primary-admin'];
      }

      // PERMISOS
      // Lectura: Cualquier miembro autenticado de la empresa puede leer archivos.
      // Útil para que todos los usuarios puedan ver imágenes de productos, logos, etc.
      allow read: if isMemberOfCompany(companyId);

      // Escritura: Solo los administradores pueden crear, actualizar o eliminar archivos.
      // Esto protege contra la subida de archivos no deseados por parte de empleados.
      allow write: if isAdminOfCompany(companyId);
    }
  }
}
