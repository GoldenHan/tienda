rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =======================================
    // Bloqueo por defecto
    // =======================================
    match /{document=**} {
      allow read, write: if false;
    }

    // =======================================
    // Colecci√≥n de usuarios individual
    // =======================================
    match /users/{userId} {
      // El usuario puede leer su propio perfil
      allow read: if request.auth != null && request.auth.uid == userId;
      // Escritura desde el cliente no permitida, solo server actions
      allow write: if false;
    }

    // =======================================
    // Usuarios de la empresa (para administradores)
    // =======================================
    match /companies/{companyId}/users/{userId} {
      // Lectura: admins de la empresa
      allow read: if request.auth != null && isAdminOfCompany(companyId);

      // Escritura: admins de la empresa
      allow create, update, delete: if request.auth != null && isAdminOfCompany(companyId);
    }

    // =======================================
    // Colecciones generales de la empresa
    // =======================================
    match /companies/{companyId}/{document=**} {
      allow read: if isMemberOfCompany(companyId);
    }

    match /companies/{companyId}/{collect}/{docId} {
      allow write: if isAdminOfCompany(companyId);
    }

    // =======================================
    // Funciones helper
    // =======================================
    function isMemberOfCompany(companyId) {
      return request.auth != null && request.auth.token.companyId == companyId;
    }

    function isAdminOfCompany(companyId) {
      return isMemberOfCompany(companyId) &&
             (request.auth.token.role == 'admin' || request.auth.token.role == 'primary-admin');
    }
  }
}
