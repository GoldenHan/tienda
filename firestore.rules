rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Functions ---
    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserCompanyId() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    function getUserRole(companyId) {
        return get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data.role;
    }
    
    function isUserRole(companyId, role) {
        return getUserRole(companyId) == role;
    }

    // --- Rules ---

    // The /users collection stores a lookup document for each user to find their companyId.
    // This is a critical piece for our security rules.
    match /users/{userId} {
      // Anyone can create their own user lookup document during registration.
      allow create: if isUserAuthenticated() && isOwner(userId);
      // A user can only read their own lookup document.
      allow read: if isUserAuthenticated() && isOwner(userId);
      // Users cannot update or delete their lookup document.
      allow update, delete: if false;
    }

    // The /companies collection holds all data for each company.
    match /companies/{companyId} {
      // Allow a user to create a new company. The client-side code ensures
      // the adminUid is set correctly to the user's UID.
      allow create: if isUserAuthenticated();
      
      // Allow read access to the company document if the user's companyId
      // from the /users lookup matches the companyId they are trying to read.
      allow read: if isUserAuthenticated() && getUserCompanyId() == companyId;
      
      // Company documents cannot be updated or deleted by clients.
      allow update, delete: if false;

      // --- Subcollections ---

      // Rules for the 'users' subcollection (employee/admin profiles)
      match /users/{userId} {
        // Allow creation of a user profile (during registration or by an admin).
        // For registration: the user creates their own doc.
        // For adding employees: an admin creates a doc for another user.
        allow create: if (isUserAuthenticated() && isOwner(userId)) || (isUserAuthenticated() && isUserRole(companyId, 'admin'));
        // Allow users of the same company to read user profiles.
        allow read: if isUserAuthenticated() && getUserCompanyId() == companyId;
        // Only admins can update user roles or details (not yet implemented in UI).
        allow update: if isUserAuthenticated() && isUserRole(companyId, 'admin');
        // Only admins can delete users.
        allow delete: if isUserAuthenticated() && isUserRole(companyId, 'admin');
      }

      // Rules for 'products' and 'sales' subcollections
      match /{collection=**} {
        // Allow read access if the user belongs to the company.
        allow read: if isUserAuthenticated() && getUserCompanyId() == companyId;
        // Allow write access (create, update, delete) only if the user is an admin in that company.
        // This also covers the creation of the _placeholder documents.
        allow write: if isUserAuthenticated() && getUserCompanyId() == companyId && isUserRole(companyId, 'admin');
      }
    }
  }
}
