rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Funciones de Ayuda ---
    function isMemberOfCompany(companyId) {
      return request.auth.token.companyId == companyId;
    }

    function isAdmin() {
      return request.auth.token.role == 'admin' || request.auth.token.role == 'primary-admin';
    }

    function isEmployee() {
      return request.auth.token.role == 'employee';
    }

    // --- Reglas Globales ---
    
    // Nadie puede leer/escribir la colección de empresas directamente.
    match /companies/{companyId} {
      allow read, write: if false;
    }

    // Regla para la colección de USUARIOS
    match /users/{userId} {
      // Un usuario solo puede leer/actualizar su propio documento.
      allow get, update: if request.auth.uid == userId;
      // Los administradores pueden listar todos los usuarios de su propia empresa.
      allow list: if isMemberOfCompany(resource.data.companyId) && isAdmin();
      // Nadie puede crear o eliminar usuarios directamente, debe hacerse desde el servidor.
      allow create, delete: if false;
    }

    // --- Reglas para Subcolecciones de Empresa ---
    
    // Regla general para administradores: acceso total a todo dentro de su empresa.
    match /companies/{companyId}/{document=**} {
      allow read, write: if isMemberOfCompany(companyId) && isAdmin();
    }

    // Reglas específicas para EMPLEADOS, que anulan la regla general anterior si son más específicas.
    
    // Los empleados pueden leer productos y categorías para el POS.
    match /companies/{companyId}/products/{productId} {
      allow read: if isMemberOfCompany(companyId) && isEmployee();
    }
    match /companies/{companyId}/categories/{categoryId} {
      allow read: if isMemberOfCompany(companyId) && isEmployee();
    }

    // Los empleados pueden crear nuevas ventas. No pueden leer, actualizar o eliminar.
    match /companies/{companyId}/sales/{saleId} {
      allow create: if isMemberOfCompany(companyId) && isEmployee();
    }
  }
}
