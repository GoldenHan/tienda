rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuth() {
      return request.auth != null;
    }

    function isRole(role) {
      // Safely access role from the user's custom claims, if they exist
      return isAuth() && request.auth.token.role == role;
    }

    function isEmployee() {
      return isAuth() && (request.auth.token.role == 'admin' || request.auth.token.role == 'employee');
    }
    
    // Allow anyone to check if users exist for initial setup
    match /users/{userId} {
      allow list: if true;
      allow read, write: if isAuth() && request.auth.uid == userId;
    }
    
    match /company/main {
      allow read: if isAuth();
      allow create, write: if isRole('admin');
    }

    match /products/{productId} {
      // Any authenticated employee can read products
      allow read: if isEmployee();
      // Only admins can write products
      allow write: if isRole('admin');
    }

    match /sales/{saleId} {
      // Any authenticated employee can read sales
      allow read: if isEmployee();
      // Any authenticated employee can create a sale
      allow create: if isEmployee();
      // Only admins can update a sale
      allow update: if isRole('admin');
      // No one can delete a sale from the client
      allow delete: if false;
    }
  }
}
