rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Functions ---
    // Gets the user's companyId from the root /users collection
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    // Checks if the requesting user is a member of a specific company
    function isCompanyMember(companyId) {
      return request.auth != null && getUserCompanyId() == companyId;
    }

    // Checks if the user has a specific role in their company
    function hasRole(role) {
      let companyId = getUserCompanyId();
      return isCompanyMember(companyId) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // --- Rules ---

    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // -- Registration --
    // Allow any authenticated user to create a company and their own user documents
    match /companies/{companyId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.adminUid;
    }

    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      // Allow a user to read their own lookup document
      allow read: if request.auth != null && request.auth.uid == userId;
    }

    // -- App Data Access --
    match /companies/{companyId} {
      // Allow company members to read company data
      allow read: if isCompanyMember(companyId);
    }
    
    // Products Subcollection
    match /companies/{companyId}/products/{productId} {
      // Allow read if user is part of the company.
      // The placeholder document is filtered out on the client-side query.
      allow read: if isCompanyMember(companyId);
      // Only admins can create, update, or delete products.
      allow write: if hasRole('admin');
    }

    // Sales Subcollection
    match /companies/{companyId}/sales/{saleId} {
      // Allow read if user is part of the company.
      // The placeholder document is filtered out on the client-side query.
      allow read: if isCompanyMember(companyId);
      // Employees can create sales (POS), but only admins can edit/delete history.
      allow create: if hasRole('admin') || hasRole('employee');
      allow update, delete: if hasRole('admin');
    }

    // Users Subcollection
    match /companies/{companyId}/users/{userId} {
      // Allow company members to list/read user profiles in their company
      allow read: if isCompanyMember(companyId);
      // Only admins can add, update, or remove users
      allow write: if hasRole('admin');
    }
  }
}
