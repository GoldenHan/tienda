rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    //---------------------------------
    // Helper Functions
    //---------------------------------
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserCompanyId() {
      // Get the user's companyId from the root /users/{uid} lookup document.
      // This is the key to our security model.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    function getUserRole(companyId) {
      // Get the user's role from their profile within the company's subcollection.
      return get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data.role;
    }
    
    function isUserAdmin(companyId) {
      // Check if the user's role is 'admin' for the given company.
      return isAuthenticated() && getUserRole(companyId) == 'admin';
    }

    //---------------------------------
    // /users/{userId} (Root lookup collection)
    //---------------------------------
    match /users/{userId} {
      // Allow a user to read their own lookup document.
      // Allow a user to create their own lookup document during registration.
      allow read, create: if isAuthenticated() && request.auth.uid == userId;
    }

    //---------------------------------
    // /companies/{companyId}
    //---------------------------------
    match /companies/{companyId} {

      // CREATE: Allow a user to create a company document only if:
      // 1. They are authenticated.
      // 2. The companyId they are creating matches the one specified in their user lookup doc.
      // 3. The adminUid field in the new document is their own UID.
      allow create: if isAuthenticated() 
                      && companyId == getUserCompanyId()
                      && request.resource.data.adminUid == request.auth.uid;

      // READ: Allow a user to read a company document only if 
      // the companyId matches the one in their user lookup document.
      allow read: if isAuthenticated() && companyId == getUserCompanyId();
      
      // UPDATE: Only an admin of that company can update its details.
      allow update: if isUserAdmin(companyId);

      // DELETE: Never allow deleting a company.
      allow delete: if false;


      //---------------------------------
      // /companies/{companyId}/users/{userId}
      //---------------------------------
      match /users/{userId} {
        // CREATE:
        // Allow creating a user profile if:
        // 1. The user is creating their OWN profile and setting themselves as 'admin' (registration).
        // 2. The requester is already an admin of this company (adding employees).
        allow create: if (isAuthenticated() && request.auth.uid == userId && request.resource.data.role == 'admin')
                      || isUserAdmin(companyId);
        
        // READ & LIST: Users of a company can read the user list of that same company.
        allow read: if isAuthenticated() && companyId == getUserCompanyId();

        // UPDATE: An admin can update any user, or a user can update their own profile.
        allow update: if isUserAdmin(companyId) || (isAuthenticated() && request.auth.uid == userId);
        
        // DELETE: An admin can delete a user, but not themselves.
        allow delete: if isUserAdmin(companyId) && request.auth.uid != userId;
      }
      
      //---------------------------------
      // Generic Subcollection Rules
      //---------------------------------
      match /{subcollection}/{docId} 
        where subcollection in ['products', 'sales'] {
        
        // READ: Any authenticated user belonging to the company can read.
        allow read: if isAuthenticated() && companyId == getUserCompanyId();

        // WRITE (Products): Only admins can manage products.
        allow write: if subcollection == 'products' && isUserAdmin(companyId);
        
        // CREATE (Sales): Any authenticated user belonging to the company can create sales (for POS).
        allow create: if subcollection == 'sales' && isAuthenticated() && companyId == getUserCompanyId();

        // UPDATE/DELETE (Sales): Only admins can edit or delete past sales.
        allow update, delete: if subcollection == 'sales' && isUserAdmin(companyId);
      }
    }
  }
}
