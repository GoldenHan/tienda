rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isCompanyMember(companyId) {
      return isSignedIn() && getUserData().companyId == companyId;
    }

    function isRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    // --- Company Rules ---
    // A user can create a company document during registration.
    // A user can read their own company's document.
    // Only an admin of that company can update it.
    match /companies/{companyId} {
      allow create: if isSignedIn();
      allow read: if isCompanyMember(companyId);
      allow update: if isRole('admin') && isCompanyMember(companyId);
      allow delete: if false; // Companies cannot be deleted

      // --- Product Subcollection ---
      // Any company member can read products (needed for POS).
      // Reading handles empty collections safely.
      // Only admins can manage the product inventory.
      match /products/{productId} {
        allow read: if isCompanyMember(companyId) && (!('initialized' in resource.data) || resource.data.initialized != true);
        allow create, update, delete: if isRole('admin') && isCompanyMember(companyId);
      }

      // --- Sales Subcollection ---
      // Any company member can create a sale.
      // Reading/updating/deleting sales is restricted to admins for reporting and management.
      match /sales/{saleId} {
        allow read, update, delete: if isRole('admin') && isCompanyMember(companyId);
        allow create: if isCompanyMember(companyId);
      }
    }
    
    // --- Root Users Collection (for role/company lookup) ---
    // A user can create their own user lookup document during registration.
    // A user can only read their own document.
    // Admins can create new user documents (employees).
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isRole('admin');
      allow create: if request.auth.uid == userId || isRole('admin');
      allow update: if isRole('admin');
      allow delete: if false; // Users cannot be deleted for now
    }
  }
}
