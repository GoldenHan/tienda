
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================

    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica si el UID del solicitante existe en la subcolección de usuarios de la empresa
    // y si su rol es 'admin'.
    function isAdmin(companyId) {
      let userDoc = get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid));
      return isAuthenticated() && userDoc.data.role == 'admin';
    }

    // Verifica si el UID del solicitante existe en la subcolección de usuarios de la empresa.
    function isMemberOfCompany(companyId) {
       return isAuthenticated() && exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid));
    }


    // =================================
    // Companies Collection
    // =================================
    match /companies/{companyId} {
      // El documento de la empresa puede ser leído por sus miembros.
      // Solo puede ser creado por el usuario que se convierte en admin.
      // Solo el admin puede actualizarlo.
      allow read: if isMemberOfCompany(companyId);
      allow create: if request.auth.uid == request.resource.data.adminUid;
      allow update: if isAdmin(companyId);
      allow delete: if false;

      // --- Users Subcollection ---
      match /users/{userId} {
        // Un usuario puede leer los datos de otros usuarios en su misma empresa.
        allow read: if isMemberOfCompany(companyId);

        // El admin puede crear nuevos usuarios (empleados).
        allow create: if isAdmin(companyId);

        // Un usuario puede actualizar su propio perfil, o un admin puede actualizar cualquier perfil.
        allow update: if (isAuthenticated() && request.auth.uid == userId) || isAdmin(companyId);

        // Solo un admin puede eliminar a un usuario, y no puede eliminarse a sí mismo.
        allow delete: if isAdmin(companyId) && request.auth.uid != userId;
      }

      // --- Products Subcollection ---
      match /products/{productId} {
        allow read: if isMemberOfCompany(companyId);
        allow create, update, delete: if isAdmin(companyId);
      }

      // --- Sales Subcollection ---
      match /sales/{saleId} {
        allow read: if isMemberOfCompany(companyId);
        // Cualquier miembro de la empresa (admin o empleado) puede crear una venta.
        allow create: if isMemberOfCompany(companyId);
        // Solo el admin puede modificar o eliminar el historial de ventas.
        allow update, delete: if isAdmin(companyId);
      }
    }
  }
}
