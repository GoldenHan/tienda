rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    // Checks if a user document exists within a company's 'users' subcollection.
    // This is the core of our security model.
    function isMemberOfCompany(companyId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid));
    }
    
    // Gets the user's role. This can only be called if the rule has already established
    // read access to the user's document (e.g., by using isMemberOfCompany).
    function getUserRole(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data.role;
    }

    // --- Root 'users' Collection (for company lookup) ---
    match /users/{userId} {
      // A user can create and read their own lookup document.
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- 'companies' Collection ---
    match /companies/{companyId} {
      // CREATION: Allow a user to create a company only if they are authenticated and
      // are setting themselves as the admin. This is used during the initial registration.
      allow create: if isAuthenticated() && request.resource.data.adminUid == request.auth.uid;
      
      // READ: Allow a user to read the company document if they are a member of that company.
      allow read: if isMemberOfCompany(companyId);

      // UPDATE: Only an admin of that company can update its details.
      allow update: if isMemberOfCompany(companyId) && getUserRole(companyId) == 'admin';

      // DELETE: Companies cannot be deleted.
      allow delete: if false;


      // --- 'users' Subcollection ---
      match /users/{userId} {
        // READ: Any member of the company can read the list of users.
        allow read: if isMemberOfCompany(companyId);

        // CREATE:
        // 1. A new user can create their own 'admin' profile during company registration.
        // 2. An existing admin can create new 'employee' users.
        allow create: if (isAuthenticated() && request.auth.uid == userId && request.resource.data.role == 'admin') ||
                         (isMemberOfCompany(companyId) && getUserRole(companyId) == 'admin');

        // UPDATE: An admin can update any user, or a user can update their own profile.
        allow update: if (isMemberOfCompany(companyId) && getUserRole(companyId) == 'admin') || (isAuthenticated() && request.auth.uid == userId);
        
        // DELETE: An admin can delete a user, but not themselves.
        allow delete: if (isMemberOfCompany(companyId) && getUserRole(companyId) == 'admin' && request.auth.uid != userId);
      }
      
      // --- 'products' Subcollection ---
      match /products/{productId} {
        // Any member of the company can read products.
        allow read: if isMemberOfCompany(companyId);
        // Only admins can create, update, or delete products.
        allow write: if isMemberOfCompany(companyId) && getUserRole(companyId) == 'admin';
      }

      // --- 'sales' Subcollection ---
      match /sales/{saleId} {
         // Any member of the company can read sales history.
        allow read: if isMemberOfCompany(companyId);
        // Any member can create a new sale (for the POS).
        allow create: if isMemberOfCompany(companyId);
        // Only admins can update or delete sales records.
        allow update, delete: if isMemberOfCompany(companyId) && getUserRole(companyId) == 'admin';
      }
    }
  }
}
