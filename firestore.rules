
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    function isUserRole(role) {
      let companyId = getUserCompanyId();
      return get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data.role == role;
    }

    // --- Root Collections ---

    match /users/{userId} {
      // A user can create their own lookup document.
      // A user can only read their own lookup document.
      allow read: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
      allow write: if false; // Should not be editable after creation
    }

    match /companies/{companyId} {
      // Allow a user to read/write to company data if their companyId matches.
      allow read: if getUserCompanyId() == companyId;
      
      // Any authenticated user can create a company, as long as they set themselves as the admin.
      allow create: if request.auth.uid != null && request.resource.data.adminUid == request.auth.uid;

      // --- Sub-collections ---

      match /users/{userId} {
        // Allow reading user profiles if they are in the same company.
        allow read: if getUserCompanyId() == companyId;
        
        // Allow a user to create their own profile document within a company.
        // Also allow an admin to add new users (employees).
        allow create: if (request.auth.uid == userId) || (isUserRole('admin') && getUserCompanyId() == companyId);
        
        allow write: if isUserRole('admin') && getUserCompanyId() == companyId;
      }

      match /products/{productId} {
        allow read: if getUserCompanyId() == companyId;
        allow write: if isUserRole('admin') && getUserCompanyId() == companyId;
      }

      match /sales/{saleId} {
        allow read: if getUserCompanyId() == companyId;
        // Admins can edit sales, employees can create them.
        allow create: if (isUserRole('admin') || isUserRole('employee')) && getUserCompanyId() == companyId;
        allow update: if isUserRole('admin') && getUserCompanyId() == companyId;
        allow delete: if false; // Sales should not be deleted
      }
    }
  }
}
