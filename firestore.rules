rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    // Gets the user's company ID from their root user document.
    // This is the primary lookup.
    function getCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }

    // Gets the user's full data record from within their company's subcollection.
    // This should only be called after verifying the user belongs to the company.
    function getUserData(companyId) {
       return get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data;
    }

    // Checks if the user is trying to access a resource within their own company.
    function isWithinOwnCompany(companyId) {
      return isAuthenticated() && getCompanyId() == companyId;
    }

    // Checks if the user has the 'admin' role within their own company.
    function isAdmin(companyId) {
      // First, check if they belong to the company they are trying to access.
      // Then, check their role in the user data record.
      return isWithinOwnCompany(companyId) && getUserData(companyId).role == 'admin';
    }


    // --- Collection Rules ---

    // Rule for the root 'users' collection (company lookup)
    // Any authenticated user can read and write their OWN user lookup document.
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Rules for 'companies' and their subcollections
    match /companies/{companyId} {
      
      // Allow a user to create a company if they are authenticated and are assigning themselves as the admin.
      allow create: if isAuthenticated() && request.resource.data.adminUid == request.auth.uid;
      
      // Allow a user to read their own company's document.
      allow read: if isWithinOwnCompany(companyId);
      
      // Only an admin of that company can update the company document.
      allow update: if isAdmin(companyId);

      // Disallow deleting companies.
      allow delete: if false;


      // -- Subcollection: users --
      match /users/{userId} {
        
        // Allow creating a user document if:
        // 1. You are creating yourself as the first admin.
        // 2. You are an existing admin of this company creating a new user.
        allow create: if (isAuthenticated() && request.auth.uid == userId && request.resource.data.role == 'admin') || isAdmin(companyId);
        
        // Any user within the company can read user profiles of that company.
        allow read: if isWithinOwnCompany(companyId);

        // An admin can update any user, or a user can update their own profile.
        allow update: if isAdmin(companyId) || (isAuthenticated() && request.auth.uid == userId);
        
        // An admin can delete any user except themselves.
        allow delete: if isAdmin(companyId) && request.auth.uid != userId;
      }

      // -- Subcollection: products --
      match /products/{productId} {
        // Any user within the company can read products.
        allow read: if isWithinOwnCompany(companyId);
        // Only admins can create, update, or delete products.
        allow write: if isAdmin(companyId);
      }

      // -- Subcollection: sales --
      match /sales/{saleId} {
        // Any user within the company can read sales history.
        allow read: if isWithinOwnCompany(companyId);
        // Any user within the company can create a new sale (for the POS).
        allow create: if isWithinOwnCompany(companyId);
        // Only admins can update or delete sales records.
        allow update, delete: if isAdmin(companyId);
      }
    }
  }
}
