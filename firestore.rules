rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------
    // Helpers
    // --------------------------
    function isAuthenticated() {
      return request.auth != null;
    }

    // Checks if a user document exists within a company's user subcollection
    function isUserInCompany(companyId, userId) {
      return exists(/databases/$(database)/documents/companies/$(companyId)/users/$(userId));
    }

    // Gets the user's data document from within a company
    function getUserData(companyId, userId) {
      return get(/databases/$(database)/documents/companies/$(companyId)/users/$(userId)).data;
    }

    // Checks if the requesting user is an admin of the specified company
    function isAdmin(companyId) {
      let userId = request.auth.uid;
      return isAuthenticated() 
          && isUserInCompany(companyId, userId)
          && getUserData(companyId, userId).role == 'admin';
    }

    // Checks if the requesting user is at least an employee of the specified company
    function isEmployee(companyId) {
       let userId = request.auth.uid;
      return isAuthenticated() && isUserInCompany(companyId, userId);
    }
    
    // --------------------------
    // /users collection (for company lookup)
    // --------------------------
    match /users/{userId} {
      // Allow a user to read their own lookup document to find their companyId
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Allow a user to create their own lookup document during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }

    // --------------------------
    // /companies collection
    // --------------------------
    match /companies/{companyId} {
      // Allow a user to read their own company's details if they are an employee
      allow read: if isEmployee(companyId);

      // Allow a user to create a company if they are authenticated and they are the admin
      allow create: if isAuthenticated() && request.resource.data.adminUid == request.auth.uid;

      // Only admins can update company info
      allow update: if isAdmin(companyId);

      // Prevent company deletion
      allow delete: if false;


      // --------------------------
      // Subcollections within a company
      // --------------------------

      // All reads from subcollections are allowed if the user is an employee of that company.
      // Specific write permissions are handled below.
      match /{subcollection}/{docId} {
        allow read: if isEmployee(companyId);
      }

      // Products can be managed only by admins
      match /products/{productId} {
        allow write: if isAdmin(companyId);
      }
      
      // Sales can be created by any employee (for the POS) but only modified by admins
      match /sales/{saleId} {
        allow create: if isEmployee(companyId);
        allow update, delete: if isAdmin(companyId);
      }
      
      // User management is for admins, but users can update their own info.
      match /users/{userId} {
         // Allow admin to create new users (employees)
         // Allow a user to create themselves during the initial company registration
        allow create: if isAdmin(companyId) || (isAuthenticated() && request.auth.uid == userId && request.resource.data.role == 'admin');

        // Allow admin to update any user, or a user to update their own profile
        allow update: if isAdmin(companyId) || (isAuthenticated() && request.auth.uid == userId);
        
        // Admins can delete other users, but not themselves
        allow delete: if isAdmin(companyId) && request.auth.uid != userId;
      }
    }
  }
}
