
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(companyId) {
      return request.auth != null && request.auth.token.companyId == companyId && request.auth.token.role == 'primary-admin';
    }

    function isAdmin(companyId) {
      return request.auth != null && request.auth.token.companyId == companyId && (request.auth.token.role == 'admin' || request.auth.token.role == 'primary-admin');
    }

    function isMember(companyId) {
      return request.auth != null && request.auth.token.companyId == companyId;
    }

    // Allow users to read their own profile document.
    // Writes are handled by server actions, so client-side writes are denied.
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Deny all client-side writes to user profiles.
    }

    // Companies collection can be read by its members, but only updated by owner.
    match /companies/{companyId} {
      allow read: if isMember(companyId);
      allow update: if isAdmin(companyId);
      // Deny creation/deletion from client.
      allow create, delete: if false;

      // Subcollections like products, sales, etc.
      match /{subcollection}/{docId} {
        allow read: if isMember(companyId);
        allow write: if isAdmin(companyId); // Create, Update, Delete for admins
      }
    }
  }
}
