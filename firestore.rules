rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated and belongs to the specified company.
    function isMemberOfCompany(companyId) {
      return request.auth != null && request.auth.token.companyId == companyId;
    }

    // Helper function to check if the user is an admin or primary-admin of the specified company.
    function isAdminOfCompany(companyId) {
      return isMemberOfCompany(companyId) && (request.auth.token.role == 'admin' || request.auth.token.role == 'primary-admin');
    }

    // Rule for the /companies collection.
    match /companies/{companyId} {
      // Admins can read their own company's document.
      allow read: if isAdminOfCompany(companyId);

      // Only admins can update their company's settings. Owner and creation time are immutable.
      allow update: if isAdminOfCompany(companyId)
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['name', 'exchangeRate', 'pettyCashInitial', 'logoUrl']);

      // Disallow direct creation or deletion of company documents via client SDK.
      // This must be handled by a secure server environment (like a Cloud Function).
      allow create, delete: if false;
    }

    // Rule for all subcollections within a company document.
    match /companies/{companyId}/{subcollection}/{docId} {

      // --- Default Read/Write Rules for all subcollections ---
      // Any authenticated user can read data from their own company.
      // This allows employees to see products, sales history, etc.
      allow read: if isMemberOfCompany(companyId);

      // --- Granular Write Rules ---

      // Products, Categories: Only admins can manage the inventory and categories.
      allow create, update, delete: if (subcollection == 'products' || subcollection == 'categories')
                                      && isAdminOfCompany(companyId);

      // Sales:
      // Creation is handled by a server action which does its own checks.
      // We allow creation here so the server action can run with the user's credentials.
      allow create: if isMemberOfCompany(companyId);
      // Updates/Deletes (e.g., editing a sale): Restricted to admins to prevent unauthorized changes.
      allow update, delete: if isAdminOfCompany(companyId);

      // Cash flows (inflows, outflows, transfers):
      // Creation is allowed for any member, as both employees and admins might need to log these.
      // The validation (e.g., sufficient funds) is handled in the server action.
      allow create: if (subcollection == 'cash_outflows' || subcollection == 'inflows' || subcollection == 'cash_transfers')
                    && isMemberOfCompany(companyId);
      // Only admins can edit or delete past cash flow records.
      allow update, delete: if (subcollection == 'cash_outflows' || subcollection == 'inflows' || subcollection == 'cash_transfers')
                           && isAdminOfCompany(companyId);

      // Reconciliations: The status is updated via a server action.
      // We allow writes here for admins, as they have the power to reopen closed reconciliations.
      allow write: if subcollection == 'reconciliations' && isAdminOfCompany(companyId);
    }

    // Rule for the /users collection.
    match /users/{userId} {
      // An authenticated user can read their own user profile.
      allow get: if request.auth.uid == userId;

      // An admin can read the user list of their own company.
      allow list: if request.auth != null && request.auth.token.companyId != null;

      // Creation and deletion are handled by secure server actions, not allowed from the client.
      allow create, delete: if false;
      // An admin can promote other users, and a user can update their own (non-critical) data.
      // This is a simplified rule; updates are mainly handled via server actions for security.
      allow update: if request.auth.uid == userId || (request.auth.token.role == 'admin' || request.auth.token.role == 'primary-admin');
    }
  }
}
